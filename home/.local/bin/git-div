#!/bin/sh

set -e


if [ "$1" = "-h" ]; then
    cat <<EOF
Finds the commit where two branches diverged.

Usage: git div [BRANCH1] [BRANCH2]
BRANCH1 defaults to HEAD.
BRANCH2 defaults to `git default-branch` (the default branch).
EOF
    exit 0
fi


# Determine which branches to check
case "$#" in
    0)
        A="HEAD"
        B="$(git default-branch)"
        ;;

    1)
        A="$1"
        B="$(git default-branch)"
        ;;

    2)
        A="$1"
        B="$2"
        ;;
esac


AFILE="$(mktemp)"
BFILE="$(mktemp)"
trap "rm $AFILE $BFILE" EXIT


git rev-list --first-parent "$A" > "$AFILE"
git rev-list --first-parent "$B" > "$BFILE"

diff --old-line-format= --new-line-format= "$AFILE" "$BFILE" | head -n1

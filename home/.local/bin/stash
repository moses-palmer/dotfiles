#!/bin/sh
#
# Adds all non-ignored files in a repository to a commit with a marker message.
#
# If the previous commit has the masrker message, it is amended.

set -e

##
# The root of the repository.
ROOT="$(git rev-parse --show-toplevel)"

##
# The message used for a stash commit.
STASH_MESSAGE="STASH"

##
# The message of the current commit.
CURRENT_MESSAGE="$(git log --format=%B -n 1 HEAD)"


# Stage everything
git add "$ROOT"

# Make a new commit or amend depending on the previous message
if [ "$CURRENT_MESSAGE" = "$STASH_MESSAGE" ]; then
    echo "Amending current stash commit"
    git commit --amend -C HEAD
else
    echo "Creating new stash commit"
    git commit --message="$STASH_MESSAGE"
fi
